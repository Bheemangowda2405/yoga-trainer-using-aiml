<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - Yoga Pose Detector</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .navbar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 1rem 2rem;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .navbar-brand {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
      }

      .nav-links {
        display: flex;
        gap: 1rem;
      }

      .nav-links a {
        text-decoration: none;
        color: #667eea;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .nav-links a:hover {
        background: rgba(102, 126, 234, 0.1);
      }

      .profile-container {
        max-width: 800px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .profile-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 3rem 2rem;
        text-align: center;
        position: relative;
      }

      .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid white;
        margin: 0 auto 1rem;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        overflow: hidden;
      }

      .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .profile-name {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .profile-email {
        opacity: 0.9;
        font-size: 1.1rem;
      }

      .profile-content {
        padding: 2rem;
      }

      .profile-section {
        margin-bottom: 2rem;
      }

      .section-title {
        font-size: 1.3rem;
        color: #333;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #f1f3f4;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #555;
        font-weight: 500;
      }

      .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e5e9;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #f8f9fa;
      }

      .form-control:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-control:disabled {
        background: #f8f9fa;
        color: #666;
        cursor: not-allowed;
      }

      select.form-control {
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%23666' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 12px;
        padding-right: 40px;
      }

      textarea.form-control {
        resize: vertical;
        min-height: 100px;
      }

      .avatar-preview {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 2px solid #e1e5e9;
        margin-top: 0.5rem;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        font-size: 2rem;
      }

      .avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn-success {
        background: linear-gradient(135deg, #51cf66, #40c057);
        color: white;
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(81, 207, 102, 0.3);
      }

      .btn-secondary.account-settings {
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        color: white;
      }

      .btn-secondary.account-settings:hover {
        background: linear-gradient(135deg, #ee5a52, #dc3545);
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
      }

      .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        justify-content: flex-end;
      }

      .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
      }

      .alert {
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        text-align: center;
      }

      .alert.success {
        background: #e8f5e8;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .alert.error {
        background: #fee;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      @media (max-width: 768px) {
        .profile-container {
          margin: 0 10px;
        }

        .action-buttons {
          flex-direction: column;
        }

        .nav-links {
          flex-direction: column;
          gap: 0.5rem;
        }

        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar">
      <div class="navbar-brand">üßò‚Äç‚ôÄÔ∏è Yoga Pose Detector</div>
      <div class="nav-links">
        <a href="{{ url_for('dashboard') }}">Dashboard</a>
        <a href="{{ url_for('webcam') }}">Practice</a>
        <a href="{{ url_for('logout') }}">Logout</a>
      </div>
    </nav>

    <!-- Profile Container -->
    <div class="profile-container">
      <!-- Profile Header -->
      <div class="profile-header">
        <div class="profile-avatar" id="avatarDisplay">
          <!-- Avatar will be loaded here -->
          üë§
        </div>
        <h1 class="profile-name" id="fullNameDisplay">Loading...</h1>
        <div class="profile-email" id="emailDisplay">{{ user.email }}</div>
      </div>

      <!-- Profile Content -->
      <div class="profile-content">
        <!-- Flash Messages -->
        <div id="flashMessages"></div>

        <!-- Profile Form -->
        <form id="profileForm">
          <div class="profile-section">
            <h2 class="section-title">Personal Information</h2>

            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name</label>
                <input
                  type="text"
                  id="firstName"
                  name="first_name"
                  class="form-control"
                  disabled
                />
              </div>

              <div class="form-group">
                <label for="lastName">Last Name</label>
                <input
                  type="text"
                  id="lastName"
                  name="last_name"
                  class="form-control"
                  disabled
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="gender">Gender</label>
                <select id="gender" name="gender" class="form-control" disabled>
                  <option value="">Select Gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                  <option value="other">Other</option>
                  <option value="prefer_not_to_say">Prefer not to say</option>
                </select>
              </div>

              <div class="form-group">
                <label for="age">Age</label>
                <input
                  type="number"
                  id="age"
                  name="age"
                  class="form-control"
                  min="1"
                  max="120"
                  placeholder="Enter your age"
                  disabled
                />
              </div>
            </div>

            <div class="form-group">
              <label for="avatarUrl">Avatar URL</label>
              <input
                type="url"
                id="avatarUrl"
                name="avatar_url"
                class="form-control"
                placeholder="https://example.com/avatar.jpg"
                disabled
              />
              <div class="avatar-preview" id="avatarPreview">üë§</div>
            </div>
          </div>

          <div class="profile-section">
            <h2 class="section-title">About Me</h2>
            <div class="form-group">
              <label for="bio">Bio</label>
              <textarea
                id="bio"
                name="bio"
                class="form-control"
                placeholder="Tell us about your yoga journey..."
                disabled
              ></textarea>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button
              type="button"
              id="accountSettingsBtn"
              class="btn btn-secondary account-settings"
              onclick="window.location.href='{{ url_for('account_settings') }}'"
            >
              üîí Account Settings
            </button>
            <button type="button" id="editBtn" class="btn btn-primary">
              ‚úèÔ∏è Edit Profile
            </button>
            <button
              type="button"
              id="cancelBtn"
              class="btn btn-secondary"
              style="display: none"
            >
              ‚ùå Cancel
            </button>
            <button
              type="submit"
              id="saveBtn"
              class="btn btn-success"
              style="display: none"
            >
              üíæ Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Global variables
      let isEditing = false;
      let originalData = {};

      // DOM Elements
      const profileForm = document.getElementById("profileForm");
      const editBtn = document.getElementById("editBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const saveBtn = document.getElementById("saveBtn");
      const flashMessages = document.getElementById("flashMessages");

      // Form fields
      const firstNameInput = document.getElementById("firstName");
      const lastNameInput = document.getElementById("lastName");
      const genderInput = document.getElementById("gender");
      const ageInput = document.getElementById("age");
      const avatarUrlInput = document.getElementById("avatarUrl");
      const bioInput = document.getElementById("bio");
      const avatarPreview = document.getElementById("avatarPreview");
      const avatarDisplay = document.getElementById("avatarDisplay");
      const fullNameDisplay = document.getElementById("fullNameDisplay");
      const emailDisplay = document.getElementById("emailDisplay");

      // Load profile data when page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadProfileData();
      });

      // Load profile data from backend
      async function loadProfileData() {
        try {
          showLoading();

          const response = await fetch("/api/user/profile");
          if (!response.ok) {
            throw new Error("Failed to load profile data");
          }

          const userData = await response.json();
          console.log("Profile data loaded:", userData);

          populateForm(userData);
          updateDisplay(userData);
        } catch (error) {
          console.error("Error loading profile:", error);
          showMessage("Error loading profile data", "error");
        }
      }

      // Populate form with user data
      function populateForm(userData) {
        const profile = userData.profile || {};

        firstNameInput.value = profile.first_name || "";
        lastNameInput.value = profile.last_name || "";
        genderInput.value = profile.gender || "";
        ageInput.value = profile.age || "";
        avatarUrlInput.value = profile.avatar_url || "";
        bioInput.value = profile.bio || "";

        // Store original data for cancel operation
        originalData = {
          first_name: profile.first_name || "",
          last_name: profile.last_name || "",
          gender: profile.gender || "",
          age: profile.age || "",
          avatar_url: profile.avatar_url || "",
          bio: profile.bio || "",
        };

        updateAvatarPreview(profile.avatar_url);
      }

      // Update display elements
      function updateDisplay(userData) {
        const profile = userData.profile || {};
        const firstName = profile.first_name || "";
        const lastName = profile.last_name || "";

        // Update full name display
        if (firstName || lastName) {
          fullNameDisplay.textContent = `${firstName} ${lastName}`.trim();
        } else {
          fullNameDisplay.textContent = userData.username || "User";
        }

        // Update avatar display
        updateAvatarDisplay(profile.avatar_url);

        // Update email
        emailDisplay.textContent = userData.email || "";
      }

      // Update avatar preview
      function updateAvatarPreview(avatarUrl) {
        if (avatarUrl) {
          avatarPreview.innerHTML = `<img src="${avatarUrl}" alt="Avatar Preview" onerror="this.style.display='none'">`;
        } else {
          avatarPreview.innerHTML = "üë§";
        }
      }

      // Update main avatar display
      function updateAvatarDisplay(avatarUrl) {
        if (avatarUrl) {
          avatarDisplay.innerHTML = `<img src="${avatarUrl}" alt="Avatar" onerror="this.style.display='none'">`;
        } else {
          avatarDisplay.innerHTML = "üë§";
        }
      }

      // Enable/disable form editing
      function setEditingMode(editing) {
        isEditing = editing;

        const fields = [
          firstNameInput,
          lastNameInput,
          genderInput,
          ageInput,
          avatarUrlInput,
          bioInput,
        ];
        fields.forEach((field) => {
          field.disabled = !editing;
        });

        editBtn.style.display = editing ? "none" : "inline-flex";
        cancelBtn.style.display = editing ? "inline-flex" : "none";
        saveBtn.style.display = editing ? "inline-flex" : "none";
      }

      // Show loading state
      function showLoading() {
        firstNameInput.value = "Loading...";
        lastNameInput.value = "Loading...";
        bioInput.value = "Loading...";
      }

      // Show message to user
      function showMessage(message, type = "success") {
        flashMessages.innerHTML = `
                <div class="alert ${type}">
                    ${message}
                </div>
            `;

        // Auto-hide after 5 seconds
        setTimeout(() => {
          flashMessages.innerHTML = "";
        }, 5000);
      }

      // Event Listeners
      editBtn.addEventListener("click", function () {
        setEditingMode(true);
      });

      cancelBtn.addEventListener("click", function () {
        // Restore original data
        firstNameInput.value = originalData.first_name;
        lastNameInput.value = originalData.last_name;
        genderInput.value = originalData.gender;
        ageInput.value = originalData.age;
        avatarUrlInput.value = originalData.avatar_url;
        bioInput.value = originalData.bio;

        updateAvatarPreview(originalData.avatar_url);
        setEditingMode(false);
      });

      // Avatar URL change listener
      avatarUrlInput.addEventListener("input", function () {
        updateAvatarPreview(this.value);
      });

      // Form submission
      profileForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        if (!isEditing) return;

        try {
          saveBtn.disabled = true;
          saveBtn.innerHTML = "‚è≥ Saving...";

          const formData = {
            first_name: firstNameInput.value.trim(),
            last_name: lastNameInput.value.trim(),
            gender: genderInput.value,
            age: ageInput.value ? parseInt(ageInput.value) : null,
            avatar_url: avatarUrlInput.value.trim(),
            bio: bioInput.value.trim(),
          };

          const response = await fetch("/api/user/profile", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          });

          if (!response.ok) {
            throw new Error("Failed to update profile");
          }

          const result = await response.json();
          console.log("Profile updated:", result);

          // Update display with new data
          updateDisplay({
            profile: formData,
            username: "{{ user.username }}",
            email: "{{ user.email }}",
          });

          // Update original data
          originalData = { ...formData };

          setEditingMode(false);
          showMessage("Profile updated successfully!", "success");
        } catch (error) {
          console.error("Error updating profile:", error);
          showMessage("Error updating profile", "error");
        } finally {
          saveBtn.disabled = false;
          saveBtn.innerHTML = "üíæ Save Changes";
        }
      });
    </script>
  </body>
</html>
