<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yoga AI Trainer - Live Session</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #2c1810 0%, #8b4513 25%, #daa520 50%, #ffd700 75%, #f0e68c 100%);
            background-attachment: fixed;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 165, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 255, 0, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .main-container {
            display: flex;
            height: 100vh;
            gap: 0;
            flex-direction: row;
        }
        
        /* Mediapipe Analysis Box */
        .mediapipe-analysis {
            width: 300px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-left: 2px solid rgba(255, 215, 0, 0.3);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .analysis-header {
            padding: 20px;
            background: rgba(255, 215, 0, 0.05);
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            text-align: center;
        }
        
        .analysis-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .analysis-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .pose-info {
            background: rgba(255, 215, 0, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .pose-name-full {
            font-size: 1.1rem;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .sanskrit-name {
            font-size: 0.9rem;
            color: #ffa500;
            font-style: italic;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .confidence-display-analysis {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .confidence-label {
            font-size: 0.9rem;
            color: #fff;
        }
        
        .confidence-value-analysis {
            font-size: 1rem;
            font-weight: 700;
            color: #2ed573;
        }
        
        .confidence-bar-analysis {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .confidence-fill-analysis {
            height: 100%;
            background: linear-gradient(90deg, #ff4757, #ffa502, #2ed573);
            border-radius: 3px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        /* Mediapipe Video */
        .mediapipe-video-container {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .video-title {
            font-size: 1rem;
            font-weight: 600;
            color: #ffd700;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .mediapipe-video {
            width: 100%;
            max-width: 200px;
            height: 150px;
            border-radius: 10px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            object-fit: cover;
        }
        
        /* Body Angles */
        .body-angles-container {
            background: rgba(255, 215, 0, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .angles-title {
            font-size: 1rem;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 12px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .angle-measurements {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .angle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border: 1px solid rgba(255, 215, 0, 0.1);
        }
        
        .angle-label {
            font-size: 0.85rem;
            color: #fff;
            font-weight: 500;
        }
        
        .angle-value {
            font-size: 0.9rem;
            color: #2ed573;
            font-weight: 700;
            text-shadow: 0 0 5px rgba(46, 213, 115, 0.5);
        }
        
        /* Benefits & Info */
        .benefits-container {
            background: rgba(255, 215, 0, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .benefits-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .benefits-title {
            font-size: 1rem;
            font-weight: 700;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .info-buttons {
            display: flex;
            gap: 10px;
        }
        
        .info-btn {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 15px;
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(255, 215, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffd700;
            min-width: 60px;
            backdrop-filter: blur(10px);
        }
        
        .info-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.6);
        }
        
        .info-btn.active {
            background: rgba(46, 213, 115, 0.3);
            border-color: rgba(46, 213, 115, 0.8);
            box-shadow: 0 4px 12px rgba(46, 213, 115, 0.4);
            color: #2ed573;
        }
        
        .benefits-btn.active {
            background: rgba(46, 213, 115, 0.3);
            border-color: rgba(46, 213, 115, 0.8);
            color: #2ed573;
        }
        
        .contraindications-btn.active {
            background: rgba(255, 71, 87, 0.3);
            border-color: rgba(255, 71, 87, 0.8);
            color: #ff4757;
        }
        
        
        .benefits-content, .contraindications-content, .timing-content {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .benefits-text, .contraindications-text, .timing-text {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #fff;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .benefits-content {
            background: rgba(46, 213, 115, 0.1);
            border-left: 4px solid #2ed573;
        }
        
        .contraindications-content {
            background: rgba(255, 71, 87, 0.1);
            border-left: 4px solid #ff4757;
        }
        
        
        
        /* Video Section */
        .video-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
            position: relative;
            height: 100vh;
        }
        
        .video-header {
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .session-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffd700;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        
        
        .video-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            height: calc(100vh - 120px);
            padding: 20px;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        
        /* Instructions Panel */
        .instructions-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 350px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-left: 2px solid rgba(255, 215, 0, 0.3);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .instructions-panel.show {
            transform: translateX(0);
        }
        
        .instructions-header {
            padding: 20px;
            background: rgba(255, 215, 0, 0.05);
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            text-align: center;
        }
        
        .instructions-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .instructions-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 300px);
            padding-bottom: 150px;
            margin-bottom: 20px;
        }
        
        .instructions-list {
            list-style: none;
            padding: 0;
        }
        
        .instructions-list li {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            font-size: 1rem;
            line-height: 1.6;
            color: #fff;
        }
        
        .instructions-list li:last-child {
            border-bottom: none;
        }
        
        /* Pose Title Bar */
        .pose-title-bar {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(5px);
            border-top: 2px solid rgba(255, 215, 0, 0.3);
            position: fixed;
            bottom: 70px;
            left: 10px;
            right: 320px;
            z-index: 1001;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin: 0 5px;
            max-width: 800px;
        }
        
        .current-pose-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
            background: linear-gradient(45deg, #ffd700, #ff8c00, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: glow 2s ease-in-out infinite alternate;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 50%;
        }
        
        @keyframes glow {
            from {
                text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
            to {
                text-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 0 40px rgba(255, 215, 0, 0.6);
            }
        }
        
        .detection-accuracy {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            font-weight: 600;
            color: #2ed573;
            text-shadow: 0 0 10px rgba(46, 213, 115, 0.5);
        }
        
        /* Footer Controls */
        .footer-controls {
            background: rgba(0, 0, 0, 0.4);
            padding: 12px 25px;
            backdrop-filter: blur(5px);
            border-top: 2px solid rgba(255, 215, 0, 0.3);
            position: fixed;
            bottom: 0;
            left: 10px;
            right: 320px;
            z-index: 1001;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin: 0 5px;
            max-width: 800px;
        }
        
        .control-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .toggle-panel-btn {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.4);
            color: #000;
            font-weight: 600;
        }
        
        .toggle-panel-btn:hover {
            background: linear-gradient(135deg, #ffed4e, #ffa500);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.6);
        }
        
        button {
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.4);
            font-size: 0.75rem;
            position: relative;
            overflow: hidden;
        }
        
        button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
        }
        
        button:active {
            transform: translateY(0) scale(0.98);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .language-select {
            padding: 6px 12px;
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 15px;
            background: rgba(255, 215, 0, 0.1);
            color: #ffd700;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(255, 215, 0, 0.2);
            backdrop-filter: blur(10px);
            font-size: 0.75rem;
            min-width: 120px;
        }
        
        .language-select:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
            border-color: rgba(255, 215, 0, 0.8);
        }
        
        .language-select option {
            background: #2c1810;
            color: #ffd700;
            padding: 8px;
        }
        
        #startBtn {
            background: linear-gradient(135deg, #32cd32, #90ee90);
            box-shadow: 0 4px 15px rgba(50, 205, 50, 0.4);
            color: #000;
        }
        
        #stopBtn {
            background: linear-gradient(135deg, #ff6347, #ff7f50);
            box-shadow: 0 4px 15px rgba(255, 99, 71, 0.4);
            color: #fff;
        }
        
        .status-text {
            font-size: 1rem;
            opacity: 0.8;
        }
        
        /* Scrollbar Styling */
        .detection-results::-webkit-scrollbar {
            width: 8px;
        }
        
        .detection-results::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .detection-results::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        .detection-results::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .pose-title-bar {
                left: 10px;
                right: 0;
                margin-right: 10px;
                max-width: 700px;
            }
            
            .footer-controls {
                left: 10px;
                right: 0;
                margin-right: 10px;
                max-width: 700px;
            }
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .mediapipe-analysis {
                width: 100%;
                height: 40vh;
                border-left: none;
                border-top: 2px solid rgba(255, 215, 0, 0.3);
            }
            
            .instructions-panel {
                width: 100%;
                height: 60vh;
                top: 40vh;
                right: 0;
                border-left: none;
                border-top: 2px solid rgba(255, 215, 0, 0.3);
            }
            
            .pose-title-bar {
                left: 0;
                right: 0;
                margin: 0;
                bottom: 60px;
            }
            
            .footer-controls {
                left: 0;
                right: 0;
                margin: 0;
            }
            
            .current-pose-title {
                font-size: 1.2rem;
                max-width: 70%;
            }
            
            .control-buttons {
                gap: 6px;
            }
            
            button {
                padding: 6px 12px;
                font-size: 0.75rem;
            }
            
            .info-btn {
                padding: 4px 8px;
                font-size: 0.7rem;
                min-width: 50px;
            }
        }
        
        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pose-detection-card {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .side-panel.show {
            animation: slideInFromBottom 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .video-overlay, .detection-timer {
            animation: fadeInUp 0.5s ease-out;
        }
        
        /* Loading Animation */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <!-- Main Video Section -->
        <div class="video-section">
            <div class="video-header">
                <div class="session-title">
                    🧘‍♀️ Divine Yoga AI Trainer
                </div>
            </div>
            
            <div class="video-container">
                <video id="video" autoplay playsinline muted style="display: none;"></video>
                <canvas id="canvas" style="display:none;"></canvas>
            </div>
            
            <!-- Current Pose Title -->
            <div class="pose-title-bar">
                <div class="current-pose-title">
                        <span>Current Pose: </span>
                        <span id="poseName">—</span>
                    </div>
                    <div class="detection-accuracy" id="detectionAccuracy" style="display: none;">
                        <span>Accuracy: </span>
                        <span id="confidenceValueBottom">—</span>
                    </div>
                </div>
                
            <!-- Footer Controls -->
            <div class="footer-controls">
                <div class="control-buttons">
                    <button id="togglePanelBtn" class="toggle-panel-btn">Show Instructions</button>
                    <button id="benefitsBtn" class="info-btn benefits-btn">Benefits</button>
                    <select id="languageSelect" class="language-select">
                        <option value="en">English</option>
                        <option value="hi">Hindi (हिंदी)</option>
                        <option value="kn">Kannada (ಕನ್ನಡ)</option>
                        <option value="ta">Tamil (தமிழ்)</option>
                        <option value="te">Telugu (తెలుగు)</option>
                        <option value="mr">Marathi (मराठी)</option>
                        <option value="bn">Bengali (বাংলা)</option>
                        <option value="gu">Gujarati (ગુજરાતી)</option>
                        <option value="pa">Punjabi (ਪੰਜਾਬੀ)</option>
                    </select>
                    <button id="startBtn">
                        <span>Start Session</span>
                    </button>
                    <button id="stopBtn" disabled>End Session</button>
                </div>
            </div>
        </div>
        
        <!-- Mediapipe Analysis Box -->
        <div class="mediapipe-analysis">
            <div class="analysis-header">
                <div class="analysis-title">🧘‍♀️ Pose Analysis</div>
            </div>
            <div class="analysis-content">
                <!-- Mediapipe Video -->
                <div class="mediapipe-video-container">
                    <div class="video-title">Mediapipe Analysis</div>
                    <video id="mediapipeVideo" class="mediapipe-video" autoplay playsinline muted></video>
                    <canvas id="mediapipeCanvas" style="display:none;"></canvas>
                </div>
                
                <!-- Pose Info -->
                <div class="pose-info">
                    <div class="pose-name-full" id="poseNameFull">—</div>
                    <div class="sanskrit-name" id="sanskritName">—</div>
                    <div class="confidence-display-analysis">
                        <span class="confidence-label">Confidence:</span>
                        <span class="confidence-value-analysis" id="confidenceValueAnalysis">—</span>
                    </div>
                    <div class="confidence-bar-analysis">
                        <div class="confidence-fill-analysis" id="confidenceBarAnalysis"></div>
                    </div>
                </div>
                
                <!-- Body Measurements -->
                <div class="body-angles-container">
                    <div class="angles-title">Body Analysis</div>
                    <div class="angle-measurements" id="angleMeasurements">
                        <div class="angle-item">
                            <span class="angle-label">Spine:</span>
                            <span class="angle-value" id="spineAngle">—</span>
                        </div>
                        <div class="angle-item">
                            <span class="angle-label">Knee:</span>
                            <span class="angle-value" id="kneeAngle">—</span>
                        </div>
                        <div class="angle-item">
                            <span class="angle-label">Hip:</span>
                            <span class="angle-value" id="hipAngle">—</span>
                        </div>
                        <div class="angle-item">
                            <span class="angle-label">Shoulder:</span>
                            <span class="angle-value" id="shoulderAngle">—</span>
                        </div>
                        <div class="angle-item">
                            <span class="angle-label">Arm Span:</span>
                            <span class="angle-value" id="armSpan">—</span>
                    </div>
                        <div class="angle-item">
                            <span class="angle-label">Leg Length:</span>
                            <span class="angle-value" id="legLength">—</span>
                </div>
                        <div class="angle-item">
                            <span class="angle-label">Torso:</span>
                            <span class="angle-value" id="torsoLength">—</span>
                    </div>
                        <div class="angle-item">
                            <span class="angle-label">Balance:</span>
                            <span class="angle-value" id="balanceScore">—</span>
                    </div>
                </div>
                </div>
                
            </div>
        </div>
        
        <!-- Instructions Panel -->
        <div class="instructions-panel" id="instructionsPanel">
            <div class="instructions-header">
                <div class="instructions-title" id="panelTitle">📋 Pose Instructions</div>
            </div>
            <div class="instructions-content">
                <ul class="instructions-list" id="instructionsList">
                    <li>Start session to see pose instructions</li>
                </ul>
                <div class="benefits-content" id="benefitsContent" style="display: none;">
                    <div class="benefits-text" id="benefitsText"></div>
            </div>
                <div class="contraindications-content" id="contraindicationsContent" style="display: none;">
                    <div class="contraindications-text" id="contraindicationsText"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let stream = null;
        let loopHandle = null;
        let currentPose = null;
        let poseStartTime = null;
        let lastAnnouncedPose = null;
        let currentLanguage = 'en';
        let timerInterval = null;
        let asanaData = null;
        let lastSpokenPose = null;
        let isSpeaking = false;
        
        const CAPTURE_MS = 1500; // Reduced to 1.5 seconds for faster detection
        const POSE_CONFIRMATION_TIME = 1500; // Reduced to 1.5 seconds for faster voice feedback
        
        // Full pose names with Sanskrit names, benefits, and contraindications
        const poseNames = {
            'Tree_Pose_or_Vrksasana_': {
                english: 'Tree Pose',
                sanskrit: 'Vrksasana (वृक्षासन)',
                full: 'Tree Pose (Vrksasana)',
                benefits: 'Strengthens legs, improves balance, stretches hips and thighs, enhances focus and concentration',
                contraindications: 'Avoid if you have low blood pressure, ankle or knee injuries, or severe balance issues',
                timing: 'Best done on empty stomach, early morning or evening. Hold for 30-60 seconds per side.'
            },
            'Downward-Facing_Dog_pose_or_Adho_Mukha_Svanasana_': {
                english: 'Downward-Facing Dog',
                sanskrit: 'Adho Mukha Svanasana (अधो मुख श्वानासन)',
                full: 'Downward-Facing Dog (Adho Mukha Svanasana)',
                benefits: 'Strengthens arms and legs, stretches spine, improves circulation, energizes the body',
                contraindications: 'Avoid if you have carpal tunnel syndrome, high blood pressure, or wrist injuries',
                timing: 'Best on empty stomach. Hold for 1-3 minutes. Can be done anytime of day.'
            },
            'Warrior_I_Pose_or_Virabhadrasana_I_': {
                english: 'Warrior I',
                sanskrit: 'Virabhadrasana I (वीरभद्रासन प्रथम)',
                full: 'Warrior I (Virabhadrasana I)',
                benefits: 'Strengthens legs, opens hips and chest, improves balance, builds stamina',
                contraindications: 'Avoid if you have knee or ankle injuries, high blood pressure, or heart problems',
                timing: 'Best on empty stomach. Hold for 30-60 seconds per side. Morning or evening.'
            },
            'Warrior_II_Pose_or_Virabhadrasana_II_': {
                english: 'Warrior II',
                sanskrit: 'Virabhadrasana II (वीरभद्रासन द्वितीय)',
                full: 'Warrior II (Virabhadrasana II)',
                benefits: 'Strengthens legs and arms, improves stamina, stretches groin and chest',
                contraindications: 'Avoid if you have knee or ankle injuries, or severe arthritis',
                timing: 'Best on empty stomach. Hold for 30-60 seconds per side. Any time of day.'
            },
            'Child_Pose_or_Balasana_': {
                english: 'Child Pose',
                sanskrit: 'Balasana (बालासन)',
                full: 'Child Pose (Balasana)',
                benefits: 'Calms the mind, relieves stress, stretches hips and thighs, gentle back stretch',
                contraindications: 'Avoid if you have knee injuries or are pregnant (modify with props)',
                timing: 'Can be done anytime, even after meals. Hold for 1-3 minutes or longer.'
            },
            'Cobra_Pose_or_Bhujangasana_': {
                english: 'Cobra Pose',
                sanskrit: 'Bhujangasana (भुजंगासन)',
                full: 'Cobra Pose (Bhujangasana)',
                benefits: 'Strengthens spine, opens chest, improves posture, stimulates abdominal organs',
                contraindications: 'Avoid if you have back injuries, carpal tunnel syndrome, or are pregnant',
                timing: 'Best on empty stomach. Hold for 15-30 seconds. Morning or evening.'
            },
            'Plank_Pose_or_Kumbhakasana_': {
                english: 'Plank Pose',
                sanskrit: 'Kumbhakasana (कुम्भकासन)',
                full: 'Plank Pose (Kumbhakasana)',
                benefits: 'Strengthens core, arms, and shoulders, improves posture, builds endurance',
                contraindications: 'Avoid if you have carpal tunnel syndrome, shoulder injuries, or high blood pressure',
                timing: 'Best on empty stomach. Hold for 30-60 seconds. Any time of day.'
            },
            'Bridge_Pose_or_Setu_Bandha_Sarvangasana_': {
                english: 'Bridge Pose',
                sanskrit: 'Setu Bandha Sarvangasana (सेतु बन्ध सर्वांगासन)',
                full: 'Bridge Pose (Setu Bandha Sarvangasana)',
                benefits: 'Strengthens back and legs, opens chest, improves spinal flexibility, calms the mind',
                contraindications: 'Avoid if you have neck injuries, high blood pressure, or severe back problems',
                timing: 'Best on empty stomach. Hold for 30-60 seconds. Morning or evening.'
            },
            'Corpse_Pose_or_Savasana_': {
                english: 'Corpse Pose',
                sanskrit: 'Savasana (शवासन)',
                full: 'Corpse Pose (Savasana)',
                benefits: 'Deep relaxation, reduces stress, lowers blood pressure, improves sleep quality',
                contraindications: 'No contraindications - suitable for everyone',
                timing: 'Can be done anytime. Hold for 5-15 minutes. Best at the end of practice.'
            },
            'Chair_Pose_or_Utkatasana_': {
                english: 'Chair Pose',
                sanskrit: 'Utkatasana (उत्कटासन)',
                full: 'Chair Pose (Utkatasana)',
                benefits: 'Strengthens legs and core, improves balance, tones glutes and thighs',
                contraindications: 'Avoid if you have knee injuries, low blood pressure, or severe arthritis',
                timing: 'Best on empty stomach. Hold for 30-60 seconds. Morning or evening.'
            },
            'Mountain_Pose_or_Tadasana_': {
                english: 'Mountain Pose',
                sanskrit: 'Tadasana (ताडासन)',
                full: 'Mountain Pose (Tadasana)'
            },
            'Forward_Fold_or_Uttanasana_': {
                english: 'Forward Fold',
                sanskrit: 'Uttanasana (उत्तानासन)',
                full: 'Forward Fold (Uttanasana)'
            },
            'Triangle_Pose_or_Trikonasana_': {
                english: 'Triangle Pose',
                sanskrit: 'Trikonasana (त्रिकोणासन)',
                full: 'Triangle Pose (Trikonasana)'
            },
            'Half_Moon_Pose_or_Ardha_Chandrasana_': {
                english: 'Half Moon Pose',
                sanskrit: 'Ardha Chandrasana (अर्ध चन्द्रासन)',
                full: 'Half Moon Pose (Ardha Chandrasana)'
            },
            'Eagle_Pose_or_Garudasana_': {
                english: 'Eagle Pose',
                sanskrit: 'Garudasana (गरुडासन)',
                full: 'Eagle Pose (Garudasana)'
            },
            'Camel_Pose_or_Ustrasana_': {
                english: 'Camel Pose',
                sanskrit: 'Ustrasana (उष्ट्रासन)',
                full: 'Camel Pose (Ustrasana)'
            },
            'Fish_Pose_or_Matsyasana_': {
                english: 'Fish Pose',
                sanskrit: 'Matsyasana (मत्स्यासन)',
                full: 'Fish Pose (Matsyasana)'
            },
            'Lotus_Pose_or_Padmasana_': {
                english: 'Lotus Pose',
                sanskrit: 'Padmasana (पद्मासन)',
                full: 'Lotus Pose (Padmasana)'
            },
            'Seated_Forward_Bend_or_Paschimottanasana_': {
                english: 'Seated Forward Bend',
                sanskrit: 'Paschimottanasana (पश्चिमोत्तानासन)',
                full: 'Seated Forward Bend (Paschimottanasana)'
            },
            'Revolved_Triangle_or_Parivrtta_Trikonasana_': {
                english: 'Revolved Triangle',
                sanskrit: 'Parivrtta Trikonasana (परिवृत्त त्रिकोणासन)',
                full: 'Revolved Triangle (Parivrtta Trikonasana)'
            }
        };
        
        // DOM elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const poseNameEl = document.getElementById('poseName');
        const confidenceValueBottom = document.getElementById('confidenceValueBottom');
        const detectionAccuracy = document.getElementById('detectionAccuracy');
        const instructionsList = document.getElementById('instructionsList');
        const instructionsPanel = document.getElementById('instructionsPanel');
        const togglePanelBtn = document.getElementById('togglePanelBtn');
        const poseNameFull = document.getElementById('poseNameFull');
        const sanskritName = document.getElementById('sanskritName');
        const confidenceValueAnalysis = document.getElementById('confidenceValueAnalysis');
        const confidenceBarAnalysis = document.getElementById('confidenceBarAnalysis');
        
        // New elements
        const mediapipeVideo = document.getElementById('mediapipeVideo');
        const mediapipeCanvas = document.getElementById('mediapipeCanvas');
        const spineAngle = document.getElementById('spineAngle');
        const kneeAngle = document.getElementById('kneeAngle');
        const hipAngle = document.getElementById('hipAngle');
        const shoulderAngle = document.getElementById('shoulderAngle');
        const armSpan = document.getElementById('armSpan');
        const legLength = document.getElementById('legLength');
        const torsoLength = document.getElementById('torsoLength');
        const balanceScore = document.getElementById('balanceScore');
        const benefitsText = document.getElementById('benefitsText');
        const contraindicationsText = document.getElementById('contraindicationsText');
        const benefitsContent = document.getElementById('benefitsContent');
        const contraindicationsContent = document.getElementById('contraindicationsContent');
        const benefitsBtn = document.getElementById('benefitsBtn');
        const panelTitle = document.getElementById('panelTitle');
        const languageSelect = document.getElementById('languageSelect');

        // Load asana data from JSON file
        async function loadAsanaData() {
            try {
                const response = await fetch('/static/asana_data.json');
                if (!response.ok) {
                    throw new Error('Failed to load asana data');
                }
                asanaData = await response.json();
                console.log('Asana data loaded successfully');
                console.log('Available poses:', Object.keys(asanaData));
                
                // Test with a known pose
                const testPose = 'Tree_Pose_or_Vrksasana_';
                if (asanaData[testPose]) {
                    console.log('Test pose data:', asanaData[testPose]);
                }
            } catch (error) {
                console.error('Error loading asana data:', error);
                asanaData = null;
            }
        }

        // Debug function to test pose matching
        window.testPoseMatching = function(poseName) {
            console.log('Testing pose matching for:', poseName);
            const result = getPoseDataFromJSON(poseName);
            console.log('Result:', result);
            return result;
        };

        // Debug function to test warnings display
        window.testWarningsDisplay = function(poseName) {
            console.log('Testing warnings display for:', poseName);
            const jsonData = getPoseDataFromJSON(poseName);
            console.log('JSON data:', jsonData);
            if (jsonData && jsonData.warnings) {
                console.log('Warnings found:', jsonData.warnings);
                const formatted = formatAsBulletPoints(jsonData.warnings);
                console.log('Formatted warnings:', formatted);
                return formatted;
            } else {
                console.log('No warnings found in JSON data');
                return null;
            }
        };

        // Debug function to show all available poses
        window.showAllPoses = function() {
            if (asanaData) {
                console.log('All available poses:', Object.keys(asanaData));
                return Object.keys(asanaData);
            } else {
                console.log('Asana data not loaded');
                return null;
            }
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Load asana data
            loadAsanaData();
            // Application is ready
            console.log('Yoga AI Trainer initialized');
            console.log('Use testPoseMatching("pose_name") to test pose matching');
        });


        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    } 
                });
                video.srcObject = stream;
                video.style.display = 'block'; // Make video visible
                await video.play();
                
                // Also set up mediapipe video
                mediapipeVideo.srcObject = stream;
                mediapipeVideo.style.display = 'block';
                await mediapipeVideo.play();
                
                return true;
            } catch (err) {
                console.error('Failed to start camera', err);
                return false;
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (video.srcObject) {
                video.srcObject = null;
            }
            video.style.display = 'none'; // Hide video when stopped
            mediapipeVideo.style.display = 'none'; // Hide mediapipe video when stopped
        }




        async function getInstructionsAndFeedback(poseName) {
            try {
                const response = await fetch('/get_instructions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pose_name: poseName,
                        language: 'en'
                    })
                });
                
                const data = await response.json();
                if (data.error) return null;
                
                return {
                    instructions: data.instructions,
                    feedback: data.feedback
                };
            } catch (error) {
                console.error('Error fetching instructions:', error);
                return null;
            }
        }

        async function getPoseBenefits(poseName) {
            try {
                console.log('Fetching benefits via Gemini for pose:', poseName);
                const response = await fetch('/get_pose_benefits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pose_name: poseName,
                        language: 'en'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Gemini API response:', data);
                
                if (data.error) {
                    console.error('API error:', data.error);
                    return null;
                }
                
                return {
                    benefits: data.benefits,
                    contraindications: data.contraindications
                };
            } catch (error) {
                console.error('Error fetching pose benefits from Gemini:', error);
                return null;
            }
        }

        async function getBodyMeasurements(poseName, landmarks) {
            try {
                const response = await fetch('/get_body_measurements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pose_name: poseName,
                        landmarks: landmarks
                    })
                });
                
                const data = await response.json();
                if (data.error) return null;
                
                return data;
            } catch (error) {
                console.error('Error fetching body measurements:', error);
                return null;
            }
        }

        function updateInstructions(instructions) {
            if (instructions) {
                const lines = instructions.split('\n').filter(line => line.trim());
                instructionsList.innerHTML = '';
                
                lines.forEach(line => {
                    if (line.trim().startsWith('-') || line.trim().startsWith('*')) {
                        const li = document.createElement('li');
                        li.textContent = line.trim().substring(1).trim();
                        instructionsList.appendChild(li);
                    } else if (line.trim()) {
                        const li = document.createElement('li');
                        li.textContent = line.trim();
                        instructionsList.appendChild(li);
                    }
                });
            }
        }


        function getPoseInfo(poseName) {
            return poseNames[poseName] || {
                english: poseName,
                sanskrit: poseName,
                full: poseName
            };
        }

        // Get pose data from asana_data.json
        function getPoseDataFromJSON(poseName) {
            if (!asanaData) {
                console.log('Asana data not loaded yet');
                return null;
            }
            
            console.log('Looking for pose:', poseName);
            console.log('Available poses:', Object.keys(asanaData));
            
            // Try to find the pose in the JSON data with better matching
            for (const [key, data] of Object.entries(asanaData)) {
                const keyLower = key.toLowerCase();
                const poseLower = poseName.toLowerCase();
                
                // Extract key parts for better matching
                const keyParts = keyLower.split(/[_\s-]+/);
                const poseParts = poseLower.split(/[_\s-]+/);
                
                // Check for exact match first
                if (keyLower === poseLower) {
                    console.log('Exact match found:', key);
                    return data;
                }
                
                // Check if any key part matches any pose part
                const hasMatchingPart = keyParts.some(keyPart => 
                    poseParts.some(posePart => 
                        keyPart.includes(posePart) || posePart.includes(keyPart)
                    )
                );
                
                // More flexible matching
                if (keyLower.includes(poseLower) || 
                    poseLower.includes(keyLower) ||
                    keyLower.replace(/[_\s-]/g, '').includes(poseLower.replace(/[_\s-]/g, '')) ||
                    poseLower.replace(/[_\s-]/g, '').includes(keyLower.replace(/[_\s-]/g, '')) ||
                    hasMatchingPart) {
                    console.log('Found matching pose:', key);
                    return data;
                }
            }
            
            console.log('No matching pose found for:', poseName);
            return null;
        }

        // Format benefits and warnings as bullet points
        function formatAsBulletPoints(items) {
            if (!items || !Array.isArray(items)) return 'No information available.';
            
            return items.map(item => `• ${item}`).join('\n');
        }

        // Voice feedback functions
        async function speakPoseName(poseName, language = 'en') {
            if (isSpeaking || poseName === lastSpokenPose) {
                return; // Don't speak if already speaking or same pose
            }
            
            const traditionalName = getTraditionalName(poseName);
            console.log(`🎤 Speaking pose: ${traditionalName} in ${language}`);
            
            try {
                isSpeaking = true;
                lastSpokenPose = poseName;
                
                const response = await fetch('/speak_pose_name', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pose_name: poseName,
                        language: language
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('✅ Pose name spoken successfully');
                } else {
                    console.error('❌ Failed to speak pose name:', data.message);
                }
            } catch (error) {
                console.error('❌ Error speaking pose name:', error);
            } finally {
                // Reset speaking flag after a delay
                setTimeout(() => {
                    isSpeaking = false;
                }, 2000);
            }
        }

        // Get traditional Sanskrit name for a pose (matches Python backend mapping)
        function getTraditionalName(poseName) {
            const traditionalNames = {
                "Akarna_Dhanurasana": "Akarna Dhanurasana",
                "Bharadvajas_Twist_pose_or_Bharadvajasana_I_": "Bharadvajasana I",
                "Boat_Pose_or_Paripurna_Navasana_": "Paripurna Navasana",
                "Bound_Angle_Pose_or_Baddha_Konasana_": "Baddha Konasana",
                "Bow_Pose_or_Dhanurasana_": "Dhanurasana",
                "Bridge_Pose_or_Setu_Bandha_Sarvangasana_": "Setu Bandha Sarvangasana",
                "Camel_Pose_or_Ustrasana_": "Ustrasana",
                "Cat_Cow_Pose_or_Marjaryasana_": "Marjaryasana",
                "Chair_Pose_or_Utkatasana_": "Utkatasana",
                "Child_Pose_or_Balasana_": "Balasana",
                "Cobra_Pose_or_Bhujangasana_": "Bhujangasana",
                "Cockerel_Pose": "Kukkutasana",
                "Corpse_Pose_or_Savasana_": "Savasana",
                "Cow_Face_Pose_or_Gomukhasana_": "Gomukhasana",
                "Crane_(Crow)_Pose_or_Bakasana_": "Bakasana",
                "Dolphin_Plank_Pose_or_Makara_Adho_Mukha_Svanasana_": "Makara Adho Mukha Svanasana",
                "Dolphin_Pose_or_Ardha_Pincha_Mayurasana_": "Ardha Pincha Mayurasana",
                "Downward-Facing_Dog_pose_or_Adho_Mukha_Svanasana_": "Adho Mukha Svanasana",
                "Eagle_Pose_or_Garudasana_": "Garudasana",
                "Eight-Angle_Pose_or_Astavakrasana_": "Astavakrasana",
                "Extended_Puppy_Pose_or_Uttana_Shishosana_": "Uttana Shishosana",
                "Extended_Revolved_Side_Angle_Pose_or_Utthita_Parsvakonasana_": "Utthita Parsvakonasana",
                "Extended_Revolved_Triangle_Pose_or_Utthita_Trikonasana_": "Utthita Trikonasana",
                "Feathered_Peacock_Pose_or_Pincha_Mayurasana_": "Pincha Mayurasana",
                "Firefly_Pose_or_Tittibhasana_": "Tittibhasana",
                "Fish_Pose_or_Matsyasana_": "Matsyasana",
                "Four-Limbed_Staff_Pose_or_Chaturanga_Dandasana_": "Chaturanga Dandasana",
                "Frog_Pose_or_Bhekasana": "Bhekasana",
                "Garland_Pose_or_Malasana_": "Malasana",
                "Gate_Pose_or_Parighasana_": "Parighasana",
                "Half_Lord_of_the_Fishes_Pose_or_Ardha_Matsyendrasana_": "Ardha Matsyendrasana",
                "Half_Moon_Pose_or_Ardha_Chandrasana_": "Ardha Chandrasana",
                "Handstand_pose_or_Adho_Mukha_Vrksasana_": "Adho Mukha Vrksasana",
                "Happy_Baby_Pose_or_Ananda_Balasana_": "Ananda Balasana",
                "Head-to-Knee_Forward_Bend_pose_or_Janu_Sirsasana_": "Janu Sirsasana",
                "Heron_Pose_or_Krounchasana_": "Krounchasana",
                "Intense_Side_Stretch_Pose_or_Parsvottanasana_": "Parsvottanasana",
                "Legs-Up-the-Wall_Pose_or_Viparita_Karani_": "Viparita Karani",
                "Locust_Pose_or_Salabhasana_": "Salabhasana",
                "Lord_of_the_Dance_Pose_or_Natarajasana_": "Natarajasana",
                "Low_Lunge_pose_or_Anjaneyasana_": "Anjaneyasana",
                "Noose_Pose_or_Pasasana_": "Pasasana",
                "Peacock_Pose_or_Mayurasana_": "Mayurasana",
                "Pigeon_Pose_or_Kapotasana_": "Kapotasana",
                "Plank_Pose_or_Kumbhakasana_": "Kumbhakasana",
                "Plow_Pose_or_Halasana_": "Halasana",
                "Pose_Dedicated_to_the_Sage_Koundinya_or_Eka_Pada_Koundinyanasana_I_and_II": "Eka Pada Koundinyanasana",
                "Rajakapotasana": "Rajakapotasana",
                "Reclining_Hand-to-Big-Toe_Pose_or_Supta_Padangusthasana_": "Supta Padangusthasana",
                "Revolved_Head-to-Knee_Pose_or_Parivrtta_Janu_Sirsasana_": "Parivrtta Janu Sirsasana",
                "Scale_Pose_or_Tolasana_": "Tolasana",
                "Scorpion_pose_or_vrischikasana": "Vrischikasana",
                "Seated_Forward_Bend_pose_or_Paschimottanasana_": "Paschimottanasana",
                "Shoulder-Pressing_Pose_or_Bhujapidasana_": "Bhujapidasana",
                "Side-Reclining_Leg_Lift_pose_or_Anantasana_": "Anantasana",
                "Side_Crane_(Crow)_Pose_or_Parsva_Bakasana_": "Parsva Bakasana",
                "Side_Plank_Pose_or_Vasisthasana_": "Vasisthasana",
                "Sitting pose 1 (normal)": "Sukhasana",
                "Split pose": "Hanumanasana",
                "Staff_Pose_or_Dandasana_": "Dandasana",
                "Standing_Forward_Bend_pose_or_Uttanasana_": "Uttanasana",
                "Standing_Split_pose_or_Urdhva_Prasarita_Eka_Padasana_": "Urdhva Prasarita Eka Padasana",
                "Standing_big_toe_hold_pose_or_Utthita_Padangusthasana": "Utthita Padangusthasana",
                "Supported_Headstand_pose_or_Salamba_Sirsasana_": "Salamba Sirsasana",
                "Supported_Shoulderstand_pose_or_Salamba_Sarvangasana_": "Salamba Sarvangasana",
                "Supta_Baddha_Konasana_": "Supta Baddha Konasana",
                "Supta_Virasana_Vajrasana": "Supta Virasana",
                "Tortoise_Pose": "Kurmasana",
                "Tree_Pose_or_Vrksasana_": "Vrksasana",
                "Upward_Bow_(Wheel)_Pose_or_Urdhva_Dhanurasana_": "Urdhva Dhanurasana",
                "Upward_Facing_Two-Foot_Staff_Pose_or_Dwi_Pada_Viparita_Dandasana_": "Dwi Pada Viparita Dandasana",
                "Upward_Plank_Pose_or_Purvottanasana_": "Purvottanasana",
                "Virasana_or_Vajrasana": "Vajrasana",
                "Warrior_III_Pose_or_Virabhadrasana_III_": "Virabhadrasana III",
                "Warrior_II_Pose_or_Virabhadrasana_II_": "Virabhadrasana II",
                "Warrior_I_Pose_or_Virabhadrasana_I_": "Virabhadrasana I",
                "Wide-Angle_Seated_Forward_Bend_pose_or_Upavistha_Konasana_": "Upavistha Konasana",
                "Wide-Legged_Forward_Bend_pose_or_Prasarita_Padottanasana_": "Prasarita Padottanasana",
                "Wild_Thing_pose_or_Camatkarasana_": "Camatkarasana",
                "Wind_Relieving_pose_or_Pawanmuktasana": "Pawanmuktasana",
                "Yogic_sleep_pose": "Yoga Nidra",
                "viparita_virabhadrasana_or_reverse_warrior_pose": "Viparita Virabhadrasana"
            };
            
            return traditionalNames[poseName] || poseName;
        }

        async function updatePoseDisplay(poseName, confidence, landmarks = null) {
            const poseInfo = getPoseInfo(poseName);
            const confidencePercent = Math.round(confidence * 100);
            
            // Always update analysis box with current data
            confidenceValueAnalysis.textContent = confidencePercent + '%';
            confidenceBarAnalysis.style.width = confidencePercent + '%';
            
            // Update body angles - try to get real measurements if landmarks available
            if (landmarks && confidence >= 0.60) {
                try {
                    const measurements = await getBodyMeasurements(poseName, landmarks);
                    if (measurements) {
                        updateBodyAngles(poseName, confidence, measurements);
                    } else {
            updateBodyAngles(poseName, confidence);
                    }
                } catch (error) {
                    console.error('Error getting body measurements:', error);
                    updateBodyAngles(poseName, confidence);
                }
            } else {
                updateBodyAngles(poseName, confidence);
            }
            
            // Only show pose names if accuracy is 60% and above
            if (confidence >= 0.60) {
                // Get traditional name from the backend mapping
                const traditionalName = getTraditionalName(poseName);
                
                // Update main pose name with traditional Sanskrit name only
                poseNameEl.textContent = traditionalName;
                
                // Update analysis box - show English name in analysis box
                poseNameFull.textContent = poseInfo.english || poseName;
                sanskritName.textContent = traditionalName;
                
                // Set current pose for info buttons - use the original pose name for JSON matching
                currentPoseForInfo = poseName;
                console.log('Current pose set for info:', currentPoseForInfo);
                
                // Update benefits information
                updateBenefitsInfo(poseInfo);
                
                // Show accuracy in bottom bar
                confidenceValueBottom.textContent = confidencePercent + '%';
                detectionAccuracy.style.display = 'flex';
                
                // Immediate voice feedback for pose detection
                if (poseName !== lastSpokenPose) {
                    speakPoseName(poseName, currentLanguage);
                }
            } else {
                // Hide pose names and accuracy when below 60%
                poseNameEl.textContent = '—';
                poseNameFull.textContent = '—';
                sanskritName.textContent = '—';
                detectionAccuracy.style.display = 'none';
                
                // Clear benefits info
                benefitsText.textContent = 'Start session to see pose benefits';
                contraindicationsText.style.display = 'none';
                currentPoseForInfo = null;
            }
        }
        
        function updateBodyAngles(poseName, confidence, measurements = null) {
            if (measurements) {
                // Use real measurements from API
                spineAngle.textContent = measurements.spine_angle + '°';
                kneeAngle.textContent = measurements.knee_angle + '°';
                hipAngle.textContent = measurements.hip_angle + '°';
                shoulderAngle.textContent = measurements.shoulder_angle + '°';
                armSpan.textContent = measurements.arm_span + ' cm';
                legLength.textContent = measurements.leg_length + ' cm';
                torsoLength.textContent = measurements.torso_length + ' cm';
                balanceScore.textContent = measurements.balance_score + '%';
            } else {
                // Fallback to simulated measurements
            const angles = calculateBodyAngles(poseName, confidence);
            spineAngle.textContent = angles.spine + '°';
            kneeAngle.textContent = angles.knee + '°';
            hipAngle.textContent = angles.hip + '°';
            shoulderAngle.textContent = angles.shoulder + '°';
                armSpan.textContent = angles.arm_span + ' cm';
                legLength.textContent = angles.leg_length + ' cm';
                torsoLength.textContent = angles.torso_length + ' cm';
                balanceScore.textContent = angles.balance_score + '%';
            }
        }
        
        function calculateBodyAngles(poseName, confidence) {
            // Simulate angle calculations based on pose type
            const baseAngles = {
                spine: Math.round(180 + (Math.random() - 0.5) * 20),
                knee: Math.round(90 + (Math.random() - 0.5) * 30),
                hip: Math.round(90 + (Math.random() - 0.5) * 20),
                shoulder: Math.round(90 + (Math.random() - 0.5) * 15),
                arm_span: Math.round(150 + (Math.random() - 0.5) * 20),
                leg_length: Math.round(80 + (Math.random() - 0.5) * 15),
                torso_length: Math.round(50 + (Math.random() - 0.5) * 10),
                balance_score: Math.round(85 + (Math.random() - 0.5) * 15)
            };
            
            // Adjust based on pose type
            if (poseName.includes('Tree') || poseName.includes('Vrksasana')) {
                baseAngles.knee = Math.round(45 + Math.random() * 20);
                baseAngles.hip = Math.round(60 + Math.random() * 20);
                baseAngles.balance_score = Math.round(70 + Math.random() * 20);
            } else if (poseName.includes('Warrior')) {
                baseAngles.knee = Math.round(90 + Math.random() * 30);
                baseAngles.hip = Math.round(45 + Math.random() * 30);
                baseAngles.balance_score = Math.round(80 + Math.random() * 15);
            } else if (poseName.includes('Child') || poseName.includes('Balasana')) {
                baseAngles.spine = Math.round(90 + Math.random() * 20);
                baseAngles.knee = Math.round(45 + Math.random() * 15);
                baseAngles.balance_score = Math.round(90 + Math.random() * 10);
            }
            
            return baseAngles;
        }
        
        function updateBenefitsInfo(poseInfo) {
            // Update current pose for info buttons
            currentPoseForInfo = poseInfo.english || poseInfo.full || poseInfo.sanskrit;
            
            // Store pose info for later use - use local data for instant availability
            if (poseInfo.benefits) {
                benefitsText.textContent = poseInfo.benefits;
            }
            if (poseInfo.contraindications) {
                contraindicationsText.textContent = poseInfo.contraindications;
            }
        }


        async function captureAndPredict() {
            if (!video.videoWidth || !video.videoHeight) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.7));
            const form = new FormData();
            form.append('file', new File([blob], 'frame.jpg', { type: 'image/jpeg' }));

            try {
                const res = await fetch('/predict', { method: 'POST', body: form });
                const data = await res.json();
                if (data.error) {
                    console.error(data.error);
                    return;
                }
                
                // Update current pose for info buttons
                if (data.confidence >= 0.60) {
                    currentPoseForInfo = data.pose;
                }
                
                // For now, we'll use simulated landmarks since we need to extract them from MediaPipe
                // In a real implementation, you would extract landmarks from the MediaPipe results
                const simulatedLandmarks = generateSimulatedLandmarks(data.pose, data.confidence);
                await updatePoseDisplay(data.pose, data.confidence, simulatedLandmarks);
                
                // Optimized pose confirmation logic - only show when accuracy >= 60%
                if (data.pose === currentPose) {
                    if (poseStartTime && (Date.now() - poseStartTime) >= POSE_CONFIRMATION_TIME) {
                        if (data.pose !== lastAnnouncedPose && data.confidence >= 0.60) {
                            lastAnnouncedPose = data.pose;
                            
                            // Get instructions and feedback in parallel for speed
                            const instructionsData = await getInstructionsAndFeedback(data.pose);
                            if (instructionsData) {
                                updateInstructions(instructionsData.instructions);
                            }
                            
                            // Reset timer for next pose
                            poseStartTime = Date.now();
                        }
                    }
                } else {
                    // New pose detected, reset timer
                    currentPose = data.pose;
                    poseStartTime = Date.now();
                    lastAnnouncedPose = null;
                }
                
            } catch (e) {
                console.error(e);
            }
        }

        function generateSimulatedLandmarks(poseName, confidence) {
            // Generate simulated landmarks for testing
            // In a real implementation, these would come from MediaPipe pose detection
            const landmarks = [];
            for (let i = 0; i < 33; i++) {
                landmarks.push([
                    Math.random() * 2 - 1,  // x coordinate
                    Math.random() * 2 - 1,  // y coordinate
                    Math.random() * 2 - 1   // z coordinate
                ]);
            }
            return landmarks.flat();
        }

        function startLoop() {
            if (loopHandle) return;
            poseStartTime = Date.now();
            lastAnnouncedPose = null;
            
            captureAndPredict();
            loopHandle = setInterval(captureAndPredict, CAPTURE_MS);
        }

        function stopLoop() {
            if (loopHandle) {
                clearInterval(loopHandle);
                loopHandle = null;
            }
        }

        function resetUI() {
            poseNameEl.textContent = '—';
            poseNameFull.textContent = '—';
            sanskritName.textContent = '—';
            confidenceValueBottom.textContent = '—';
            confidenceValueAnalysis.textContent = '—';
            confidenceBarAnalysis.style.width = '0%';
            detectionAccuracy.style.display = 'none';
            instructionsList.innerHTML = '<li>Start session to see pose instructions</li>';
            
            // Reset body measurements
            spineAngle.textContent = '—';
            kneeAngle.textContent = '—';
            hipAngle.textContent = '—';
            shoulderAngle.textContent = '—';
            armSpan.textContent = '—';
            legLength.textContent = '—';
            torsoLength.textContent = '—';
            balanceScore.textContent = '—';
            
            // Reset panel content
            benefitsContent.style.display = 'none';
            contraindicationsContent.style.display = 'none';
            instructionsList.style.display = 'block';
            panelTitle.textContent = '📋 Pose Instructions';
            
            // Reset button states
            benefitsBtn.classList.remove('active');
            
            // Reset visibility states
            benefitsVisible = false;
            
            poseStartTime = null;
            lastAnnouncedPose = null;
            currentPoseForInfo = null;
        }

        startBtn.addEventListener('click', async () => {
            // Start camera first
            const cameraStarted = await startCamera();
            if (cameraStarted) {
                startLoop();
                startBtn.disabled = true;
                stopBtn.disabled = false;
            }
        });

        stopBtn.addEventListener('click', () => {
            stopLoop();
            stopCamera(); // Stop the webcam when end session is pressed
            resetUI();
            // Enable start button for restart
            startBtn.disabled = false;
            stopBtn.disabled = true;
        });

        // Toggle panel functionality
        let panelVisible = false;
        
        togglePanelBtn.addEventListener('click', () => {
            panelVisible = !panelVisible;
            if (panelVisible) {
                instructionsPanel.classList.add('show');
                togglePanelBtn.textContent = 'Hide Instructions';
                
                // Show instructions by default
                instructionsList.style.display = 'block';
                benefitsContent.style.display = 'none';
                contraindicationsContent.style.display = 'none';
                panelTitle.textContent = '📋 Pose Instructions';
                
                // Reset button states
                benefitsBtn.classList.remove('active');
                benefitsVisible = false;
            } else {
                instructionsPanel.classList.remove('show');
                togglePanelBtn.textContent = 'Show Instructions';
            }
        });
        
        // Info buttons functionality
        let benefitsVisible = false;
        let currentPoseForInfo = null;
        
        benefitsBtn.addEventListener('click', async () => {
            benefitsVisible = !benefitsVisible;
            if (benefitsVisible) {
                // Show instructions panel
                instructionsPanel.classList.add('show');
                panelVisible = true;
                togglePanelBtn.textContent = 'Hide Instructions';
                
                // Hide other content
                instructionsList.style.display = 'none';
                contraindicationsContent.style.display = 'none';
                
                // Show benefits content
                benefitsContent.style.display = 'block';
                panelTitle.textContent = '💪 Pose Benefits';
                
                if (currentPoseForInfo) {
                    try {
                        console.log('Fetching benefits for pose:', currentPoseForInfo);
                        benefitsText.textContent = 'Loading benefits...';
                        
                        // First try to get data from asana_data.json
                        const jsonData = getPoseDataFromJSON(currentPoseForInfo);
                        console.log('JSON data for benefits:', jsonData);
                        if (jsonData && jsonData.benefits && jsonData.benefits.length > 0) {
                            console.log('Using JSON benefits:', jsonData.benefits);
                            benefitsText.textContent = formatAsBulletPoints(jsonData.benefits);
                        } else {
                            // Fallback to Gemini API
                            const benefitsData = await getPoseBenefits(currentPoseForInfo);
                            console.log('Benefits data received:', benefitsData);
                            if (benefitsData && benefitsData.benefits) {
                                benefitsText.textContent = benefitsData.benefits;
                            } else {
                                // Fallback to local data
                                const poseInfo = getPoseInfo(currentPoseForInfo);
                                if (poseInfo.benefits) {
                                    benefitsText.textContent = poseInfo.benefits;
                                } else {
                                    benefitsText.textContent = 'No benefits information available.';
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error loading benefits:', error);
                        // Fallback to local data
                        const poseInfo = getPoseInfo(currentPoseForInfo);
                        if (poseInfo.benefits) {
                            benefitsText.textContent = poseInfo.benefits;
                        } else {
                            benefitsText.textContent = 'Error loading benefits. Please try again.';
                        }
                    }
                } else {
                    console.log('No current pose for info');
                    benefitsText.textContent = 'No pose detected. Please start a session.';
                }
                benefitsBtn.classList.add('active');
            } else {
                benefitsContent.style.display = 'none';
                benefitsBtn.classList.remove('active');
            }
        });
        
        


        // Language selection event listener
        languageSelect.addEventListener('change', (e) => {
            currentLanguage = e.target.value;
            console.log('Language changed to:', currentLanguage);
        });

        // Initialize with default state
        startBtn.disabled = false;
        stopBtn.disabled = true;
    </script>
</body>
</html>
